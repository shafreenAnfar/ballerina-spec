name: Daft Build

on:
  push:
    tags:    
      - '*'
jobs:
  build_draft_spec:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.WEBSITE_TOKEN }}

    steps:
      - name: Echo
        run: echo $GITHUB_REF
        
      - name: Checkout ballerina-spec
        uses: actions/checkout@v2

      - name: Clone ballerina-dev-website
        run: git clone https://ballerina-bot:$GITHUB_TOKEN@github.com/shafreenAnfar/ballerina-dev-website.git

      - name: Make the new folder location
        run: |
          cd ballerina-dev-website/spec/draft
          array=($(echo $GITHUB_REF | tr "/" "\n"))
          len=${#array[@]}
          echo "${array[len-1]}"
          mkdir "${array[len-1]}"
          pwd
          echo "::set-env name=NEW_FOLDER::${array[len-1]}"

      - name: Make
        run: |
          sudo apt-get install -y xsltproc
          cd lang
          make all
          pwd
          cp -r build/lib/ ../ballerina-dev-website/spec/draft/$NEW_FOLDER
          cp -r build/style/ ../ballerina-dev-website/spec/draft/$NEW_FOLDER
          cp -r build/spec.html ../ballerina-dev-website/spec/draft/$NEW_FOLDER/index.html

      - name: Sync ballerina-spec with dev ballerina.io
        run: |
          cd ballerina-dev-website
          git checkout automate-spec-sync-$GITHUB_SHA 2>/dev/null || git checkout -b automate-spec-sync-$GITHUB_SHA
          git pull origin master

          git config --global user.email "ballerina-bot@ballerina.org"
          git config --global user.name "shafreenAnfar"

          git add spec/draft/$NEW_FOLDER
          git commit --allow-empty -m 'Create new draft spec'
          
          git push --set-upstream origin automate-spec-sync-$GITHUB_SHA
          echo 'Successfully pushed to automate-spec-sync-$GITHUB_SHA branch'

      - name: Create pull request for spec-sync
        shell: bash
        run: |
          cd ballerina-dev-website
          curl -fsSL https://github.com/github/hub/raw/master/script/get | bash -s 2.14.1
          bin/hub pull-request -m '[Automated] Sync tag ${NEW_FOLDER} with dev ballerina.io'
        env:
          GITHUB_TOKEN: ${{ secrets.WEBSITE_TOKEN }}
          NEW_FOLDER: ${{ env.NEW_FOLDER }}
